<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>拼客后台管理</title>
    <link th:href="@{/css/app.css}" rel="stylesheet">
    <script th:src="@{/js/app.js}"></script>
    <script th:src="@{/bootstrap-3.4.1-dist/js/bootstrap.min.js}"></script>
    <link rel="stylesheet" th:href="@{/bootstrap-3.4.1-dist/css/bootstrap.min.css}">
    <style type="text/css">
        .setsidebg{
            background: url("http://pic.616pic.com/bg_w1180/00/01/31/fMe4mGEbpr.jpg!/fw/880");
        }
        .setbgnodisplay{
            background-color:rgba(0,0,0,0);
        }
        .setmainbg{
            background-size: 200% auto;
            background-repeat: no-repeat;
            background-image: url("http://pic.616pic.com/bg_w1180/00/00/76/Oet6WBYtwc.jpg!/fw/1120");
        }
    </style>
</head>

<body>
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">详细信息</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ...
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="itemPersonName" class="col-sm-3 control-label">项目发起人</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="itemPersonName"></p>
                            <span id="msgSpan1" class="help-block"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemCreationTime" class="col-sm-3 control-label">发起时间</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="itemCreationTime"></p>
                            <span id="msgSpan2" class="help-block"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemEndTime" class="col-sm-3 control-label">终止时间</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="itemEndTime"></p>
                            <span id="msgSpan3" class="help-block"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemType" class="col-sm-3 control-label">项目类型</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="itemType"></p>
                            <span id="msgSpan4" class="help-block"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemRequirement" class="col-sm-3 control-label">具体要求</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="itemRequirement"></p>
                            <span id="msgSpan5" class="help-block"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemContactNum" class="col-sm-3 control-label">联系人</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="itemContactNum"></p>
                            <span id="msgSpan7" class="help-block"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemOriginFile" class="col-sm-3 control-label">文件下载</label>
                        <div class="col-sm-9">
                            <a class="form-control-static" id="itemOriginFile">点我下载</a>
                            <!--                            <button id="itemOriginFile">点我下载</button>-->
                            <span id="msgSpan8" class="help-block"></span>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="acceptItem">接受</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="refuseModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel1">拒绝用户请求</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ...
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="itemPersonName" class="col-sm-3 control-label">拒绝原因</label>
                        <div class="col-sm-9">
                            <textarea class="form-control" id="refuseMessage" placeholder="请输入拒绝的原因"
                                      rows="3"></textarea>
                            <span id="msgSpan11" class="help-block" style="color: red"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="refuseItem">确认拒绝</button>
            </div>
        </div>
    </div>
</div>

<div class="wrapper">
    <div th:include="common::sideBar"></div>
    <div class="main setmainbg">
        <nav class="navbar navbar-expand navbar-light">
            <!--css冲突，临时排版-->
            <div class="col-9"></div>
            <div class="navbar-collapse collapse">
                <ul class="navbar-nav navbar-align">
                    <li class="nav-item dropdown">
                        <a class="nav-link d-none d-sm-inline-block" href="#" data-toggle="dropdown">
                            <span class="text-dark"><span style="color: whitesmoke">欢迎&nbsp;&nbsp;[[${session.theAdmin.realName}]]&nbsp;&nbsp;回来</span></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" th:href="@{/logout}">退出登录</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="content">
            <div class="container-fluid p-0">
                <h1 class="h3 mb-3" style="color: whitesmoke">待处理事项</h1>
                <div class="row">
                    <div class="col-12">
                        <div class="card" style="background-color: #fff">
                            <!-- 显示表格数据 -->
                            <div class="row">
                                <div class="col-md-12">
                                    <table id="orderTable" class="table table-hover">
                                        <tr>
                                            <th><h4>#</h4></th>
                                            <th><h4>发起人</h4></th>
                                            <th><h4>创建时间</h4></th>
                                            <th><h4>终止时间</h4></th>
                                            <th><h4>需求类型</h4></th>
                                            <th><h4>操作</h4></th>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div class="card-body">

                                <!-- 显示分页信息 -->
                                <div class="row">
                                    <!--分页文字信息  -->
                                    <div class="col-md-6">当前 [[${pageInfo.pageNum}]]页,总[[${pageInfo.pages}]]
                                        页,总 [[${pageInfo.total }]] 条记录
                                    </div>
                                    <!-- 分页条信息 -->
                                    <div class="col-md-6">
                                        <nav aria-label="Page navigation">
                                            <ul class="pagination">
                                                <li><a th:href="@{/admin/toBeSolved/1}">首页</a></li>
                                                <li th:if="${pageInfo.hasPreviousPage}">
                                                    <a th:href="@{'/admin/toBeSolved/'+${(pageInfo.pageNum)-1}}" aria-label="Previous">
                                                        <span aria-hidden="true">&laquo;</span>
                                                    </a>
                                                </li>

                                                <li th:if="${pages[0]} == ${pageInfo.pageNum}" class="active">
                                                    <a href="#" th:text="${pages[0]}"></a>
                                                </li>
                                                <li th:if="${pages[0]} != ${pageInfo.pageNum}">
                                                    <a th:if="${pages[0]}!=0" th:href="@{'/admin/toBeSolved/'+${pages[0]}}">
                                                        [[${pages[0]}]]
                                                    </a>
                                                </li>

                                                <li th:if="${pages[1]} == ${pageInfo.pageNum}" class="active">
                                                    <a href="#" th:text="${pages[1]}"></a>
                                                </li>
                                                <li th:if="${pages[1]} != ${pageInfo.pageNum}">
                                                    <a th:if="${pages[1]}!=0" th:href="@{'/admin/toBeSolved/'+${pages[1]}}">
                                                        [[${pages[1]}]]
                                                    </a>
                                                </li>

                                                <li th:if="${pages[2]} == ${pageInfo.pageNum}" class="active">
                                                    <a href="#" th:text="${pages[2]}"></a>
                                                </li>
                                                <li th:if="${pages[2]} != ${pageInfo.pageNum}">
                                                    <a th:if="${pages[2]}!=0" th:href="@{'/admin/toBeSolved/'+${pages[2]}}">
                                                        [[${pages[2]}]]
                                                    </a>
                                                </li>

                                                <li th:if="${pages[3]} == ${pageInfo.pageNum}" class="active">
                                                    <a href="#" th:text="${pages[3]}"></a>
                                                </li>
                                                <li th:if="${pages[3]} != ${pageInfo.pageNum}">
                                                    <a th:if="${pages[3]}!=0" th:href="@{'/admin/toBeSolved/'+${pages[3]}}">
                                                        [[${pages[3]}]]
                                                    </a>
                                                </li>

                                                <li th:if="${pages[4]} == ${pageInfo.pageNum}" class="active">
                                                    <a href="#" th:text="${pages[4]}"></a>
                                                </li>
                                                <li th:if="${pages[4]} != ${pageInfo.pageNum}">
                                                    <a th:if="${pages[4]}!=0" th:href="@{'/admin/toBeSolved/'+${pages[4]}}">
                                                        [[${pages[4]}]]
                                                    </a>
                                                </li>
                                                <li th:if="${pageInfo.hasNextPage}">
                                                    <a th:href="@{'/admin/toBeSolved/'+${(pageInfo.pageNum)+1}}" aria-label="Next">
                                                        <span aria-hidden="true">&raquo;</span>
                                                    </a>
                                                </li>
                                                <li><a th:href="@{'/admin/toBeSolved/'+${pageInfo.pages}}">末页</a></li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        //更新待处理任务
        $.ajax({
            url: "/admin/toBeSolvedJson/" + [[${pageInfo.pageNum}]],
            data: "",
            type: "GET",
            success: function (result) {
                $.each(result.list, function (index, item) {
                    var idTd = $("<td></td>").append(item.itemId);
                    var nameTd = $("<td></td>").append(item.contactName);
                    var createTimeTd = $("<td></td>").append(item.formattedCreateTime);
                    var endTimeTd = $("<td></td>").append(item.formattedEndTime);
                    var typeTd = $("<td></td>").append(item.itemType);
                    var detailBut = $("<button></button>").addClass("btn btn-primary btn-sm");
                    detailBut.append($("<span class='glyphicon glyphicon-pencil' aria-hidden='true'></span>"));
                    detailBut.append('详情');
                    var deleteBut = $("<button></button>").addClass("btn btn-danger btn-sm");
                    deleteBut.append($("<span class='glyphicon glyphicon-trash' aria-hidden='true'></span>"));
                    var editTd = $("<td></td>").append(detailBut).append(deleteBut);
                    deleteBut.append('拒绝');
                    var outerTr = $("<tr></tr>").append(idTd).append(nameTd).append(createTimeTd)
                        .append(endTimeTd).append(typeTd).append(editTd);
                    $("#orderTable").append(outerTr);
                });
            }
        });

        //确认拒绝用户申请
        $(document).on("click", "#refuseItem", function () {
            if ($("#refuseMessage").val() == "") {
                $("#msgSpan11").text("请指出拒绝理由");
            } else {
                $("#msgSpan11").empty();
                $.ajax({
                    url: "/item/refuseItem",
                    data: "itemId=" + $(this).attr("refuseId") +
                        "&adminId=" + [[${session.theAdmin.adminId}]] +
                        "&refuseReason=" + $("#refuseMessage").val(),
                    type: "PUT",
                    success: function (result) {
                        alert(result);
                        location.reload();
                    }
                });
                $("#refuseModal").modal("hide");
            }
        });

        //进入拒绝栏
        $(document).on("click", ".btn.btn-danger.btn-sm", function () {
            $("#refuseItem").attr("refuseId", $(this).parent().parent().children().first().text());
            $("#msgSpan11").empty();
            $("#refuseModal").modal("show");
        });

        // 查看用户申请详情
        $(document).on("click", ".btn.btn-primary.btn-sm", function () {
            $.ajax({
                url: "/item/getItemById",
                data: "id=" + $(this).parent().parent().children().first().text(),
                type: "GET",
                success: function (result) {
                    // itemPersonName itemCreationTime itemEndTime itemType
                    // itemRequirement itemContactName itemContactNum itemOriginFile
                    $("#acceptItem").attr("item_to_operate", result.itemId);
                    $("#itemPersonName").text(result.contactName);
                    $("#itemCreationTime").text(result.createTime);
                    $("#itemEndTime").text(result.endTime);
                    $("#itemType").text(result.itemType);
                    $("#itemRequirement").text(result.requirement);
                    $("#itemContactNum").text(result.contactNumber);
                    $("#itemOriginFile").attr("href", result.uploadAddress);

                    // item_id  user_id  create_time   end_time    item_type  requirement     contact_name  contact_number  admin_id  item_status  upload_address     download_address

                    // admin_id  item_status  download_address
                }
            });
            $("#detailModal").modal("show");
        });

        // 接受用户申请
        $("#acceptItem").click(function () {
            $.ajax({
                url: "/item/acceptItem",
                data: "itemId=" + $(this).attr("item_to_operate"),
                type: "PUT",
                success: function (result) {
                    alert(result);
                    location.reload();
                    // item_id  user_id  create_time   end_time    item_type  requirement     contact_name  contact_number  admin_id  item_status  upload_address     download_address

                    // admin_id  item_status  download_address
                }
            });
            $("#detailModal").modal("hide");
        });
    });
</script>
</body>

</html>